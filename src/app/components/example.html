<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>公司樹狀圖示範</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }

    #container {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    #tree-container {
      flex: 3;
      height: 100%;
      border-right: 1px solid #ddd;
      position: relative;
    }

    #control-panel {
      flex: 1;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
      background-color: #f5f5f5;
      min-width: 300px;
    }

    .node rect {
      fill: #fff;
      stroke: #999;
      stroke-width: 1px;
    }

    .node.selected rect {
      stroke: #3498db;
      stroke-width: 3px;
    }

    .node.locked rect {
      stroke: #e74c3c;
      stroke-width: 2px;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .company-card {
      cursor: pointer;
    }

    .company-name {
      font-weight: bold;
      font-size: 14px;
    }

    .action-button {
      cursor: pointer;
    }

    .action-button:hover circle {
      fill: #eaeaea;
    }

    .report-list {
      margin-top: 20px;
    }

    .report-item {
      padding: 10px;
      background-color: white;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .report-item h4 {
      margin: 0 0 5px 0;
    }

    .report-date {
      color: #666;
      font-size: 12px;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    button:hover {
      background-color: #2980b9;
    }

    button.danger {
      background-color: #e74c3c;
    }

    button.danger:hover {
      background-color: #c0392b;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 50%;
      max-width: 500px;
    }

    .tree-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    h3 {
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="tree-container">
    <div class="tree-controls">
      <button onclick="zoomIn()">放大</button>
      <button onclick="zoomOut()">縮小</button>
      <button onclick="resetZoom()">重設</button>
    </div>
  </div>
  <div id="control-panel">
    <h2>公司樹狀圖管理</h2>
    <button onclick="addNewCompany()">新增公司</button>
    <button onclick="expandAll()">展開全部</button>
    <button onclick="collapseAll()">收合全部</button>

    <div id="company-details">
      <h3>公司詳情</h3>
      <p>請從左側選擇一個公司</p>
    </div>

    <div id="reports-panel">
      <h3>報告列表</h3>
      <div id="report-list">
        <p>請先選擇一個公司</p>
      </div>
    </div>
  </div>
</div>

<div id="company-modal" class="modal">
  <div class="modal-content">
    <h3 id="company-modal-title">新增公司</h3>
    <input id="company-name-input" placeholder="公司名稱" />
    <div>
      <button onclick="saveCompany()">儲存</button>
      <button onclick="closeModal('company-modal')">取消</button>
    </div>
  </div>
</div>

<div id="report-modal" class="modal">
  <div class="modal-content">
    <h3 id="report-modal-title">新增報告</h3>
    <input id="report-title-input" placeholder="報告標題" />
    <input id="report-date-input" type="date" />
    <textarea id="report-content-input" placeholder="報告內容" rows="5"></textarea>
    <div>
      <button onclick="saveReport()">儲存</button>
      <button onclick="closeModal('report-modal')">取消</button>
    </div>
  </div>
</div>

<script>
  // 初始資料
  const treeData = {
    id: "1",
    name: "總公司",
    reports: [
      { id: "r1", title: "2023年度營收報告", date: "2023-12-31", content: "本年度營收成長15%..." },
      { id: "r2", title: "2024年第一季策略", date: "2024-01-15", content: "第一季將專注於..." }
    ],
    children: [
      {
        id: "2",
        name: "研發部門",
        reports: [
          { id: "r3", title: "新產品開發計畫", date: "2024-02-10", content: "預計6月推出新產品..." }
        ],
        children: [
          { id: "5", name: "UI/UX團隊", reports: [] },
          { id: "6", name: "後端團隊", reports: [] }
        ]
      },
      {
        id: "3",
        name: "行銷部門",
        reports: [],
        locked: true
      },
      {
        id: "4",
        name: "財務部門",
        reports: [
          { id: "r4", title: "預算分配報告", date: "2024-01-20", content: "各部門預算分配如下..." }
        ]
      }
    ]
  };

  let selectedCompany = null;
  let nodeWidth = 120;
  let nodeHeight = 60;
  let svg, g;
  let zoom;

  // 初始化
  function init() {
    createTree(treeData);
    setupZoom();
  }

  // 創建樹狀圖
  function createTree(data) {
    const container = document.getElementById('tree-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // 清除現有內容
    d3.select('#tree-container').selectAll('svg').remove();

    // 創建SVG
    svg = d3.select('#tree-container')
      .append('svg')
      .attr('width', width)
      .attr('height', height);

    // 創建主群組
    g = svg.append('g')
      .attr('transform', `translate(${width / 2}, 50)`);

    // 創建層次結構
    const root = d3.hierarchy(data);

    // 設置樹狀佈局
    const treeLayout = d3.tree()
      .nodeSize([nodeWidth + 20, nodeHeight * 2]);

    // 應用佈局
    treeLayout(root);

    // 創建連接線
    const links = g.selectAll('.link')
      .data(root.links())
      .enter()
      .append('path')
      .attr('class', 'link')
      .attr('d', d3.linkVertical()
        .x(d => d.x)
        .y(d => d.y));

    // 創建節點群組
    const nodes = g.selectAll('.node')
      .data(root.descendants())
      .enter()
      .append('g')
      .attr('class', d => `node ${d.data.selected ? 'selected' : ''} ${d.data.locked ? 'locked' : ''}`)
      .attr('id', d => `company-${d.data.id}`)
      .attr('transform', d => `translate(${d.x},${d.y})`)
      .on('click', (event, d) => selectCompany(d.data));

    // 創建公司卡片
    nodes.append('rect')
      .attr('class', 'company-card')
      .attr('width', nodeWidth)
      .attr('height', nodeHeight)
      .attr('x', -nodeWidth / 2)
      .attr('y', -nodeHeight / 2)
      .attr('rx', 5)
      .attr('ry', 5);

    // 添加公司名稱
    nodes.append('text')
      .attr('class', 'company-name')
      .attr('text-anchor', 'middle')
      .attr('y', -10)
      .text(d => d.data.name);

    // 添加報告數量
    nodes.append('text')
      .attr('class', 'report-count')
      .attr('text-anchor', 'middle')
      .attr('y', 10)
      .text(d => `${d.data.reports.length} 份報告`);

    // 添加操作按鈕
    const buttonData = [
      { icon: '📝', action: 'edit', title: '編輯', x: -25 },
      { icon: '🔗', action: 'link', title: '連結', x: 0 },
      { icon: '🔒', action: 'lock', title: '鎖定', x: 25 }
    ];

    const buttonGroups = nodes.append('g')
      .attr('class', 'action-buttons')
      .attr('transform', `translate(0, ${nodeHeight / 2 - 10})`);

    buttonGroups.selectAll('.action-button')
      .data(buttonData)
      .enter()
      .append('g')
      .attr('class', d => `action-button ${d.action}-button`)
      .attr('transform', d => `translate(${d.x}, 0)`)
      .on('click', (event, d) => {
        event.stopPropagation();
        handleButtonClick(event, d);
      })
      .each(function(d) {
        // 按鈕背景
        d3.select(this).append('circle')
          .attr('r', 10)
          .attr('fill', '#f0f0f0')
          .attr('stroke', '#ccc');

        // 按鈕圖示
        d3.select(this).append('text')
          .attr('text-anchor', 'middle')
          .attr('dy', '0.35em')
          .text(d.icon)
          .attr('font-size', '10px');
      });
  }

  // 設置縮放功能
  function setupZoom() {
    zoom = d3.zoom()
      .scaleExtent([0.3, 2])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });

    svg.call(zoom);
  }

  function zoomIn() {
    svg.transition().call(zoom.scaleBy, 1.2);
  }

  function zoomOut() {
    svg.transition().call(zoom.scaleBy, 0.8);
  }

  function resetZoom() {
    svg.transition().call(zoom.transform, d3.zoomIdentity.translate(svg.attr('width') / 2, 50));
  }

  // 選擇公司
  function selectCompany(company) {
    // 更新選中狀態
    if (selectedCompany) {
      d3.select(`#company-${selectedCompany.id}`).classed('selected', false);
    }

    selectedCompany = company;
    d3.select(`#company-${company.id}`).classed('selected', true);

    // 更新公司詳情面板
    const detailsPanel = document.getElementById('company-details');
    detailsPanel.innerHTML = `
                <h3>公司詳情</h3>
                <h2>${company.name}</h2>
                <p>ID: ${company.id}</p>
                <p>狀態: ${company.locked ? '已鎖定' : '正常'}</p>
                <button onclick="addReportForCompany()">新增報告</button>
                <button onclick="editSelectedCompany()">編輯公司</button>
                ${company.locked ?
      `<button onclick="unlockCompany()">解除鎖定</button>` :
      `<button onclick="lockCompany()">鎖定公司</button>`
    }
            `;

    // 更新報告列表
    updateReportsList(company.reports);
  }

  // 更新報告列表
  function updateReportsList(reports) {
    const reportList = document.getElementById('report-list');

    if (!reports || reports.length === 0) {
      reportList.innerHTML = '<p>無報告資料</p>';
      return;
    }

    let html = '';
    reports.forEach(report => {
      html += `
                    <div class="report-item">
                        <h4>${report.title}</h4>
                        <div class="report-date">${report.date}</div>
                        <p>${report.content.substring(0, 50)}${report.content.length > 50 ? '...' : ''}</p>
                        <button onclick="editReport('${report.id}')">編輯</button>
                        <button class="danger" onclick="deleteReport('${report.id}')">刪除</button>
                    </div>
                `;
    });

    reportList.innerHTML = html;
  }

  // 按鈕點擊處理
  function handleButtonClick(event, buttonData) {
    const node = d3.select(event.target.closest('.node'));
    const companyId = node.attr('id').replace('company-', '');

    // 尋找對應的公司資料
    const findCompany = (data, id) => {
      if (data.id === id) return data;
      if (!data.children) return null;

      for (const child of data.children) {
        const found = findCompany(child, id);
        if (found) return found;
      }

      return null;
    };

    const company = findCompany(treeData, companyId);

    if (!company) return;

    switch (buttonData.action) {
      case 'edit':
        editCompany(company);
        break;
      case 'link':
        alert(`連結功能待實作 - 公司: ${company.name}`);
        break;
      case 'lock':
        company.locked = !company.locked;
        createTree(treeData);
        if (selectedCompany && selectedCompany.id === company.id) {
          selectCompany(company);
        }
        break;
    }
  }

  // 新增公司
  function addNewCompany() {
    document.getElementById('company-modal-title').textContent = '新增公司';
    document.getElementById('company-name-input').value = '';
    document.getElementById('company-modal').style.display = 'block';
  }

  // 編輯公司
  function editCompany(company) {
    document.getElementById('company-modal-title').textContent = '編輯公司';
    document.getElementById('company-name-input').value = company.name;

    const modal = document.getElementById('company-modal');
    modal.setAttribute('data-company-id', company.id);
    modal.style.display = 'block';
  }

  function editSelectedCompany() {
    if (selectedCompany) {
      editCompany(selectedCompany);
    }
  }

  // 儲存公司
  function saveCompany() {
    const modal = document.getElementById('company-modal');
    const companyId = modal.getAttribute('data-company-id');
    const companyName = document.getElementById('company-name-input').value.trim();

    if (!companyName) {
      alert('請輸入公司名稱');
      return;
    }

    if (companyId) {
      // 編輯現有公司
      const updateCompanyName = (data, id, newName) => {
        if (data.id === id) {
          data.name = newName;
          return true;
        }

        if (!data.children) return false;

        for (const child of data.children) {
          if (updateCompanyName(child, id, newName)) return true;
        }

        return false;
      };

      updateCompanyName(treeData, companyId, companyName);
    } else {
      // 新增公司
      if (!selectedCompany) {
        // 新增根層級公司
        if (!treeData.children) treeData.children = [];

        treeData.children.push({
          id: `new-${Date.now()}`,
          name: companyName,
          reports: []
        });
      } else {
        // 新增子公司
        if (!selectedCompany.children) selectedCompany.children = [];

        selectedCompany.children.push({
          id: `new-${Date.now()}`,
          name: companyName,
          reports: []
        });
      }
    }

    createTree(treeData);
    closeModal('company-modal');
  }

  // 鎖定/解鎖公司
  function lockCompany() {
    if (selectedCompany) {
      selectedCompany.locked = true;
      createTree(treeData);
      selectCompany(selectedCompany);
    }
  }

  function unlockCompany() {
    if (selectedCompany) {
      selectedCompany.locked = false;
      createTree(treeData);
      selectCompany(selectedCompany);
    }
  }

  // 報告相關功能
  function addReportForCompany() {
    if (!selectedCompany) return;

    document.getElementById('report-modal-title').textContent = '新增報告';
    document.getElementById('report-title-input').value = '';
    document.getElementById('report-date-input').value = new Date().toISOString().split('T')[0];
    document.getElementById('report-content-input').value = '';

    document.getElementById('report-modal').style.display = 'block';
  }

  function editReport(reportId) {
    if (!selectedCompany) return;

    const report = selectedCompany.reports.find(r => r.id === reportId);
    if (!report) return;

    document.getElementById('report-modal-title').textContent = '編輯報告';
    document.getElementById('report-title-input').value = report.title;
    document.getElementById('report-date-input').value = report.date;
    document.getElementById('report-content-input').value = report.content;

    const modal = document.getElementById('report-modal');
    modal.setAttribute('data-report-id', reportId);
    modal.style.display = 'block';
  }

  function saveReport() {
    if (!selectedCompany) return;

    const modal = document.getElementById('report-modal');
    const reportId = modal.getAttribute('data-report-id');
    const title = document.getElementById('report-title-input').value.trim();
    const date = document.getElementById('report-date-input').value;
    const content = document.getElementById('report-content-input').value.trim();

    if (!title || !date) {
      alert('請填寫必要欄位');
      return;
    }

    if (reportId) {
      // 編輯現有報告
      const report = selectedCompany.reports.find(r => r.id === reportId);
      if (report) {
        report.title = title;
        report.date = date;
        report.content = content;
      }
    } else {
      // 新增報告
      selectedCompany.reports.push({
        id: `r-${Date.now()}`,
        title,
        date,
        content
      });
    }

    createTree(treeData);
    updateReportsList(selectedCompany.reports);
    closeModal('report-modal');
  }

  function deleteReport(reportId) {
    if (!selectedCompany) return;

    if (confirm('確定要刪除此報告嗎？')) {
      const index = selectedCompany.reports.findIndex(r => r.id === reportId);
      if (index !== -1) {
        selectedCompany.reports.splice(index, 1);
        updateReportsList(selectedCompany.reports);
        createTree(treeData);
      }
    }
  }

  // 展開/收合
  function expandAll() {
    alert('展開全部功能待實作');
  }

  function collapseAll() {
    alert('收合全部功能待實作');
  }

  // 關閉彈窗
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.getElementById(modalId).removeAttribute('data-company-id');
    document.getElementById(modalId).removeAttribute('data-report-id');
  }

  // 監聽視窗大小變化
  window.addEventListener('resize', () => {
    createTree(treeData);
  });

  // 初始化
  window.onload = init;
</script>
</body>
</html>
