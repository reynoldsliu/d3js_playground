<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¬å¸æ¨¹ç‹€åœ–ç¤ºç¯„</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }

    #container {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    #tree-container {
      flex: 3;
      height: 100%;
      border-right: 1px solid #ddd;
      position: relative;
    }

    #control-panel {
      flex: 1;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
      background-color: #f5f5f5;
      min-width: 300px;
    }

    .node rect {
      fill: #fff;
      stroke: #999;
      stroke-width: 1px;
    }

    .node.selected rect {
      stroke: #3498db;
      stroke-width: 3px;
    }

    .node.locked rect {
      stroke: #e74c3c;
      stroke-width: 2px;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .company-card {
      cursor: pointer;
    }

    .company-name {
      font-weight: bold;
      font-size: 14px;
    }

    .action-button {
      cursor: pointer;
    }

    .action-button:hover circle {
      fill: #eaeaea;
    }

    .report-list {
      margin-top: 20px;
    }

    .report-item {
      padding: 10px;
      background-color: white;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .report-item h4 {
      margin: 0 0 5px 0;
    }

    .report-date {
      color: #666;
      font-size: 12px;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    button:hover {
      background-color: #2980b9;
    }

    button.danger {
      background-color: #e74c3c;
    }

    button.danger:hover {
      background-color: #c0392b;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 50%;
      max-width: 500px;
    }

    .tree-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    h3 {
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="tree-container">
    <div class="tree-controls">
      <button onclick="zoomIn()">æ”¾å¤§</button>
      <button onclick="zoomOut()">ç¸®å°</button>
      <button onclick="resetZoom()">é‡è¨­</button>
    </div>
  </div>
  <div id="control-panel">
    <h2>å…¬å¸æ¨¹ç‹€åœ–ç®¡ç†</h2>
    <button onclick="addNewCompany()">æ–°å¢å…¬å¸</button>
    <button onclick="expandAll()">å±•é–‹å…¨éƒ¨</button>
    <button onclick="collapseAll()">æ”¶åˆå…¨éƒ¨</button>

    <div id="company-details">
      <h3>å…¬å¸è©³æƒ…</h3>
      <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å…¬å¸</p>
    </div>

    <div id="reports-panel">
      <h3>å ±å‘Šåˆ—è¡¨</h3>
      <div id="report-list">
        <p>è«‹å…ˆé¸æ“‡ä¸€å€‹å…¬å¸</p>
      </div>
    </div>
  </div>
</div>

<div id="company-modal" class="modal">
  <div class="modal-content">
    <h3 id="company-modal-title">æ–°å¢å…¬å¸</h3>
    <input id="company-name-input" placeholder="å…¬å¸åç¨±" />
    <div>
      <button onclick="saveCompany()">å„²å­˜</button>
      <button onclick="closeModal('company-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div id="report-modal" class="modal">
  <div class="modal-content">
    <h3 id="report-modal-title">æ–°å¢å ±å‘Š</h3>
    <input id="report-title-input" placeholder="å ±å‘Šæ¨™é¡Œ" />
    <input id="report-date-input" type="date" />
    <textarea id="report-content-input" placeholder="å ±å‘Šå…§å®¹" rows="5"></textarea>
    <div>
      <button onclick="saveReport()">å„²å­˜</button>
      <button onclick="closeModal('report-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  // åˆå§‹è³‡æ–™
  const treeData = {
    id: "1",
    name: "ç¸½å…¬å¸",
    reports: [
      { id: "r1", title: "2023å¹´åº¦ç‡Ÿæ”¶å ±å‘Š", date: "2023-12-31", content: "æœ¬å¹´åº¦ç‡Ÿæ”¶æˆé•·15%..." },
      { id: "r2", title: "2024å¹´ç¬¬ä¸€å­£ç­–ç•¥", date: "2024-01-15", content: "ç¬¬ä¸€å­£å°‡å°ˆæ³¨æ–¼..." }
    ],
    children: [
      {
        id: "2",
        name: "ç ”ç™¼éƒ¨é–€",
        reports: [
          { id: "r3", title: "æ–°ç”¢å“é–‹ç™¼è¨ˆç•«", date: "2024-02-10", content: "é è¨ˆ6æœˆæ¨å‡ºæ–°ç”¢å“..." }
        ],
        children: [
          { id: "5", name: "UI/UXåœ˜éšŠ", reports: [] },
          { id: "6", name: "å¾Œç«¯åœ˜éšŠ", reports: [] }
        ]
      },
      {
        id: "3",
        name: "è¡ŒéŠ·éƒ¨é–€",
        reports: [],
        locked: true
      },
      {
        id: "4",
        name: "è²¡å‹™éƒ¨é–€",
        reports: [
          { id: "r4", title: "é ç®—åˆ†é…å ±å‘Š", date: "2024-01-20", content: "å„éƒ¨é–€é ç®—åˆ†é…å¦‚ä¸‹..." }
        ]
      }
    ]
  };

  let selectedCompany = null;
  let nodeWidth = 120;
  let nodeHeight = 60;
  let svg, g;
  let zoom;

  // åˆå§‹åŒ–
  function init() {
    createTree(treeData);
    setupZoom();
  }

  // å‰µå»ºæ¨¹ç‹€åœ–
  function createTree(data) {
    const container = document.getElementById('tree-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // æ¸…é™¤ç¾æœ‰å…§å®¹
    d3.select('#tree-container').selectAll('svg').remove();

    // å‰µå»ºSVG
    svg = d3.select('#tree-container')
      .append('svg')
      .attr('width', width)
      .attr('height', height);

    // å‰µå»ºä¸»ç¾¤çµ„
    g = svg.append('g')
      .attr('transform', `translate(${width / 2}, 50)`);

    // å‰µå»ºå±¤æ¬¡çµæ§‹
    const root = d3.hierarchy(data);

    // è¨­ç½®æ¨¹ç‹€ä½ˆå±€
    const treeLayout = d3.tree()
      .nodeSize([nodeWidth + 20, nodeHeight * 2]);

    // æ‡‰ç”¨ä½ˆå±€
    treeLayout(root);

    // å‰µå»ºé€£æ¥ç·š
    const links = g.selectAll('.link')
      .data(root.links())
      .enter()
      .append('path')
      .attr('class', 'link')
      .attr('d', d3.linkVertical()
        .x(d => d.x)
        .y(d => d.y));

    // å‰µå»ºç¯€é»ç¾¤çµ„
    const nodes = g.selectAll('.node')
      .data(root.descendants())
      .enter()
      .append('g')
      .attr('class', d => `node ${d.data.selected ? 'selected' : ''} ${d.data.locked ? 'locked' : ''}`)
      .attr('id', d => `company-${d.data.id}`)
      .attr('transform', d => `translate(${d.x},${d.y})`)
      .on('click', (event, d) => selectCompany(d.data));

    // å‰µå»ºå…¬å¸å¡ç‰‡
    nodes.append('rect')
      .attr('class', 'company-card')
      .attr('width', nodeWidth)
      .attr('height', nodeHeight)
      .attr('x', -nodeWidth / 2)
      .attr('y', -nodeHeight / 2)
      .attr('rx', 5)
      .attr('ry', 5);

    // æ·»åŠ å…¬å¸åç¨±
    nodes.append('text')
      .attr('class', 'company-name')
      .attr('text-anchor', 'middle')
      .attr('y', -10)
      .text(d => d.data.name);

    // æ·»åŠ å ±å‘Šæ•¸é‡
    nodes.append('text')
      .attr('class', 'report-count')
      .attr('text-anchor', 'middle')
      .attr('y', 10)
      .text(d => `${d.data.reports.length} ä»½å ±å‘Š`);

    // æ·»åŠ æ“ä½œæŒ‰éˆ•
    const buttonData = [
      { icon: 'ğŸ“', action: 'edit', title: 'ç·¨è¼¯', x: -25 },
      { icon: 'ğŸ”—', action: 'link', title: 'é€£çµ', x: 0 },
      { icon: 'ğŸ”’', action: 'lock', title: 'é–å®š', x: 25 }
    ];

    const buttonGroups = nodes.append('g')
      .attr('class', 'action-buttons')
      .attr('transform', `translate(0, ${nodeHeight / 2 - 10})`);

    buttonGroups.selectAll('.action-button')
      .data(buttonData)
      .enter()
      .append('g')
      .attr('class', d => `action-button ${d.action}-button`)
      .attr('transform', d => `translate(${d.x}, 0)`)
      .on('click', (event, d) => {
        event.stopPropagation();
        handleButtonClick(event, d);
      })
      .each(function(d) {
        // æŒ‰éˆ•èƒŒæ™¯
        d3.select(this).append('circle')
          .attr('r', 10)
          .attr('fill', '#f0f0f0')
          .attr('stroke', '#ccc');

        // æŒ‰éˆ•åœ–ç¤º
        d3.select(this).append('text')
          .attr('text-anchor', 'middle')
          .attr('dy', '0.35em')
          .text(d.icon)
          .attr('font-size', '10px');
      });
  }

  // è¨­ç½®ç¸®æ”¾åŠŸèƒ½
  function setupZoom() {
    zoom = d3.zoom()
      .scaleExtent([0.3, 2])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });

    svg.call(zoom);
  }

  function zoomIn() {
    svg.transition().call(zoom.scaleBy, 1.2);
  }

  function zoomOut() {
    svg.transition().call(zoom.scaleBy, 0.8);
  }

  function resetZoom() {
    svg.transition().call(zoom.transform, d3.zoomIdentity.translate(svg.attr('width') / 2, 50));
  }

  // é¸æ“‡å…¬å¸
  function selectCompany(company) {
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedCompany) {
      d3.select(`#company-${selectedCompany.id}`).classed('selected', false);
    }

    selectedCompany = company;
    d3.select(`#company-${company.id}`).classed('selected', true);

    // æ›´æ–°å…¬å¸è©³æƒ…é¢æ¿
    const detailsPanel = document.getElementById('company-details');
    detailsPanel.innerHTML = `
                <h3>å…¬å¸è©³æƒ…</h3>
                <h2>${company.name}</h2>
                <p>ID: ${company.id}</p>
                <p>ç‹€æ…‹: ${company.locked ? 'å·²é–å®š' : 'æ­£å¸¸'}</p>
                <button onclick="addReportForCompany()">æ–°å¢å ±å‘Š</button>
                <button onclick="editSelectedCompany()">ç·¨è¼¯å…¬å¸</button>
                ${company.locked ?
      `<button onclick="unlockCompany()">è§£é™¤é–å®š</button>` :
      `<button onclick="lockCompany()">é–å®šå…¬å¸</button>`
    }
            `;

    // æ›´æ–°å ±å‘Šåˆ—è¡¨
    updateReportsList(company.reports);
  }

  // æ›´æ–°å ±å‘Šåˆ—è¡¨
  function updateReportsList(reports) {
    const reportList = document.getElementById('report-list');

    if (!reports || reports.length === 0) {
      reportList.innerHTML = '<p>ç„¡å ±å‘Šè³‡æ–™</p>';
      return;
    }

    let html = '';
    reports.forEach(report => {
      html += `
                    <div class="report-item">
                        <h4>${report.title}</h4>
                        <div class="report-date">${report.date}</div>
                        <p>${report.content.substring(0, 50)}${report.content.length > 50 ? '...' : ''}</p>
                        <button onclick="editReport('${report.id}')">ç·¨è¼¯</button>
                        <button class="danger" onclick="deleteReport('${report.id}')">åˆªé™¤</button>
                    </div>
                `;
    });

    reportList.innerHTML = html;
  }

  // æŒ‰éˆ•é»æ“Šè™•ç†
  function handleButtonClick(event, buttonData) {
    const node = d3.select(event.target.closest('.node'));
    const companyId = node.attr('id').replace('company-', '');

    // å°‹æ‰¾å°æ‡‰çš„å…¬å¸è³‡æ–™
    const findCompany = (data, id) => {
      if (data.id === id) return data;
      if (!data.children) return null;

      for (const child of data.children) {
        const found = findCompany(child, id);
        if (found) return found;
      }

      return null;
    };

    const company = findCompany(treeData, companyId);

    if (!company) return;

    switch (buttonData.action) {
      case 'edit':
        editCompany(company);
        break;
      case 'link':
        alert(`é€£çµåŠŸèƒ½å¾…å¯¦ä½œ - å…¬å¸: ${company.name}`);
        break;
      case 'lock':
        company.locked = !company.locked;
        createTree(treeData);
        if (selectedCompany && selectedCompany.id === company.id) {
          selectCompany(company);
        }
        break;
    }
  }

  // æ–°å¢å…¬å¸
  function addNewCompany() {
    document.getElementById('company-modal-title').textContent = 'æ–°å¢å…¬å¸';
    document.getElementById('company-name-input').value = '';
    document.getElementById('company-modal').style.display = 'block';
  }

  // ç·¨è¼¯å…¬å¸
  function editCompany(company) {
    document.getElementById('company-modal-title').textContent = 'ç·¨è¼¯å…¬å¸';
    document.getElementById('company-name-input').value = company.name;

    const modal = document.getElementById('company-modal');
    modal.setAttribute('data-company-id', company.id);
    modal.style.display = 'block';
  }

  function editSelectedCompany() {
    if (selectedCompany) {
      editCompany(selectedCompany);
    }
  }

  // å„²å­˜å…¬å¸
  function saveCompany() {
    const modal = document.getElementById('company-modal');
    const companyId = modal.getAttribute('data-company-id');
    const companyName = document.getElementById('company-name-input').value.trim();

    if (!companyName) {
      alert('è«‹è¼¸å…¥å…¬å¸åç¨±');
      return;
    }

    if (companyId) {
      // ç·¨è¼¯ç¾æœ‰å…¬å¸
      const updateCompanyName = (data, id, newName) => {
        if (data.id === id) {
          data.name = newName;
          return true;
        }

        if (!data.children) return false;

        for (const child of data.children) {
          if (updateCompanyName(child, id, newName)) return true;
        }

        return false;
      };

      updateCompanyName(treeData, companyId, companyName);
    } else {
      // æ–°å¢å…¬å¸
      if (!selectedCompany) {
        // æ–°å¢æ ¹å±¤ç´šå…¬å¸
        if (!treeData.children) treeData.children = [];

        treeData.children.push({
          id: `new-${Date.now()}`,
          name: companyName,
          reports: []
        });
      } else {
        // æ–°å¢å­å…¬å¸
        if (!selectedCompany.children) selectedCompany.children = [];

        selectedCompany.children.push({
          id: `new-${Date.now()}`,
          name: companyName,
          reports: []
        });
      }
    }

    createTree(treeData);
    closeModal('company-modal');
  }

  // é–å®š/è§£é–å…¬å¸
  function lockCompany() {
    if (selectedCompany) {
      selectedCompany.locked = true;
      createTree(treeData);
      selectCompany(selectedCompany);
    }
  }

  function unlockCompany() {
    if (selectedCompany) {
      selectedCompany.locked = false;
      createTree(treeData);
      selectCompany(selectedCompany);
    }
  }

  // å ±å‘Šç›¸é—œåŠŸèƒ½
  function addReportForCompany() {
    if (!selectedCompany) return;

    document.getElementById('report-modal-title').textContent = 'æ–°å¢å ±å‘Š';
    document.getElementById('report-title-input').value = '';
    document.getElementById('report-date-input').value = new Date().toISOString().split('T')[0];
    document.getElementById('report-content-input').value = '';

    document.getElementById('report-modal').style.display = 'block';
  }

  function editReport(reportId) {
    if (!selectedCompany) return;

    const report = selectedCompany.reports.find(r => r.id === reportId);
    if (!report) return;

    document.getElementById('report-modal-title').textContent = 'ç·¨è¼¯å ±å‘Š';
    document.getElementById('report-title-input').value = report.title;
    document.getElementById('report-date-input').value = report.date;
    document.getElementById('report-content-input').value = report.content;

    const modal = document.getElementById('report-modal');
    modal.setAttribute('data-report-id', reportId);
    modal.style.display = 'block';
  }

  function saveReport() {
    if (!selectedCompany) return;

    const modal = document.getElementById('report-modal');
    const reportId = modal.getAttribute('data-report-id');
    const title = document.getElementById('report-title-input').value.trim();
    const date = document.getElementById('report-date-input').value;
    const content = document.getElementById('report-content-input').value.trim();

    if (!title || !date) {
      alert('è«‹å¡«å¯«å¿…è¦æ¬„ä½');
      return;
    }

    if (reportId) {
      // ç·¨è¼¯ç¾æœ‰å ±å‘Š
      const report = selectedCompany.reports.find(r => r.id === reportId);
      if (report) {
        report.title = title;
        report.date = date;
        report.content = content;
      }
    } else {
      // æ–°å¢å ±å‘Š
      selectedCompany.reports.push({
        id: `r-${Date.now()}`,
        title,
        date,
        content
      });
    }

    createTree(treeData);
    updateReportsList(selectedCompany.reports);
    closeModal('report-modal');
  }

  function deleteReport(reportId) {
    if (!selectedCompany) return;

    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å ±å‘Šå—ï¼Ÿ')) {
      const index = selectedCompany.reports.findIndex(r => r.id === reportId);
      if (index !== -1) {
        selectedCompany.reports.splice(index, 1);
        updateReportsList(selectedCompany.reports);
        createTree(treeData);
      }
    }
  }

  // å±•é–‹/æ”¶åˆ
  function expandAll() {
    alert('å±•é–‹å…¨éƒ¨åŠŸèƒ½å¾…å¯¦ä½œ');
  }

  function collapseAll() {
    alert('æ”¶åˆå…¨éƒ¨åŠŸèƒ½å¾…å¯¦ä½œ');
  }

  // é—œé–‰å½ˆçª—
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.getElementById(modalId).removeAttribute('data-company-id');
    document.getElementById(modalId).removeAttribute('data-report-id');
  }

  // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
  window.addEventListener('resize', () => {
    createTree(treeData);
  });

  // åˆå§‹åŒ–
  window.onload = init;
</script>
</body>
</html>
